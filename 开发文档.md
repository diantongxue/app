# 手机App远程控制系统 - 开发文档

## 项目概述

开发一个网站后台系统，可以远程操控手机App（如拼多多等电商App），并采集App的页面数据。

### 核心功能
1. **远程操控功能**：在网站后台可以实时查看手机App画面，并执行点击、滑动等操作
2. **数据抓包功能**：采集手机App的页面数据、元素信息、文本内容等
3. **数据可视化功能**：将抓包的数据整理成可视化图表，在网站后台展示和分析
4. **开发调试功能**：每个功能模块都提供日志框，支持日志查看、复制、清空，方便调试

### 技术栈
- **前端**：React 19 + Vite 5 + Ant Design Pro（最新版）
- **后端**：Node.js 20+ + Express + Socket.io 4
- **手机App**：Kotlin + Android SDK 34
- **数据库**：SQLite（本地部署）或 PostgreSQL

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────┐
│  前端 (React 19 + Vite + Ant Pro)   │
│  运行在浏览器                        │
└──────────────┬──────────────────────┘
               │ HTTP/WebSocket (本地网络)
┌──────────────▼──────────────────────┐
│  本地服务器 (你的电脑)               │
│  Node.js 最新版                      │
│  - WebSocket服务                     │
│  - REST API                          │
│  - ADB服务 (连接手机)                │
└──────────────┬──────────────────────┘
               │ ADB (USB/网络) + WebSocket
┌──────────────▼──────────────────────┐
│  手机客户端App (Android)            │
│  - 系统服务                          │
└──────────────┬──────────────────────┘
               │ Android API
┌──────────────▼──────────────────────┐
│  目标App (拼多多等)                  │
└─────────────────────────────────────┘
```

---

## 技术栈详情

### 前端技术栈
- **React**: 19.x（最新）
- **Umi**: 4.x（最新）- Ant Design Pro 基于 Umi 4
- **Ant Design Pro**: 最新版（基于 Umi 4）
- **Ant Design**: 5.x（最新）
- **TypeScript**: 5.x（最新）
- **Socket.io-client**: 4.x（最新）
- **ECharts / Ant Design Charts**: 数据可视化图表库（最新版）

### 后端技术栈
- **Node.js**: 20.x LTS 或 22.x（最新）
- **Express**: 4.x
- **Socket.io**: 4.x（最新）
- **TypeScript**: 5.x（可选）
- **ADB**: android-platform-tools（最新）

### 手机App技术栈
- **Kotlin**: 最新稳定版
- **Android SDK**: API 34 (Android 14)
- **最低支持**: API 24 (Android 7.0)
- **OkHttp**: 4.x（最新）
- **Gson/Moshi**: 最新版

---

## 项目结构

### 前端项目结构
```
frontend/
├── src/
│   ├── pages/
│   │   ├── device/          # 设备管理
│   │   │   ├── list/        # 设备列表
│   │   │   └── control/     # 远程控制页面
│   │   ├── data/            # 数据采集
│   │   │   ├── list/        # 数据列表
│   │   │   ├── detail/      # 数据详情
│   │   │   ├── visualization/  # 数据可视化页面
│   │   │   └── dashboard/   # 数据看板
│   │   └── user/            # 用户管理（Pro内置）
│   ├── components/
│   │   ├── ScreenViewer/    # 屏幕显示组件
│   │   ├── ControlPanel/    # 控制面板组件
│   │   ├── DataTable/       # 数据表格组件
│   │   ├── LogViewer/       # 日志查看组件（支持复制、清空）
│   │   └── DataVisualization/  # 数据可视化组件
│   │       ├── Charts/      # 图表组件
│   │       ├── Statistics/  # 统计组件
│   │       └── Dashboard/   # 数据看板
│   ├── services/
│   │   ├── api.ts           # REST API
│   │   └── websocket.ts    # WebSocket服务
│   ├── models/             # 数据模型（Umi）
│   └── utils/              # 工具函数
├── config/
│   └── config.ts           # Pro配置
└── package.json
```

### 后端项目结构
```
backend/
├── src/
│   ├── services/
│   │   ├── websocket/       # WebSocket服务
│   │   │   ├── server.ts    # WebSocket服务器
│   │   │   └── handler.ts  # 消息处理
│   │   ├── adb/             # ADB服务
│   │   │   ├── adb-manager.ts
│   │   │   └── device-connection.ts
│   │   ├── device/          # 设备管理
│   │   │   └── device-service.ts
│   │   └── data/            # 数据服务
│   │       └── data-service.ts
│   ├── api/                 # REST API
│   │   ├── device.ts
│   │   └── data.ts
│   ├── models/              # 数据模型
│   └── utils/               # 工具函数
├── config/
│   └── config.ts
└── package.json
```

### 手机App项目结构
```
android-app/
├── app/
│   ├── src/main/
│   │   ├── java/com/yourpackage/
│   │   │   ├── services/
│   │   │   │   ├── ScreenCaptureService.kt    # 屏幕录制
│   │   │   │   ├── ControlService.kt          # 控制服务
│   │   │   │   ├── DataCollectorService.kt    # 数据采集
│   │   │   │   └── WebSocketService.kt        # WebSocket通信
│   │   │   ├── ui/
│   │   │   │   └── MainActivity.kt
│   │   │   └── utils/
│   │   ├── res/
│   │   └── AndroidManifest.xml
│   └── build.gradle
└── build.gradle
```

---

## 核心功能模块

### 功能1：远程操控手机App

#### 前端模块
- 屏幕显示组件（Canvas/Video）
- 控制面板组件（点击、滑动、输入）
- 设备连接状态显示
- 操作历史记录
- 日志查看组件（实时显示操作日志，支持复制、清空）

#### 后端模块
- WebSocket服务（接收前端指令）
- ADB服务管理（连接手机）
- 指令转发服务（转发给手机App）
- 屏幕画面转发（手机 → 前端）

#### 手机App模块
- WebSocket客户端（接收指令）
- 屏幕录制服务（MediaProjection）
- 控制执行服务（AccessibilityService）
- 画面编码传输

### 功能2：抓包手机App数据

#### 前端模块
- 数据列表展示（表格）
- 数据搜索过滤
- 数据详情查看
- 数据导出功能
- 日志查看组件（显示数据采集日志，支持复制、清空）

#### 后端模块
- 数据接收服务（接收手机采集的数据）
- 数据存储服务（数据库存储）
- 数据查询API
- 数据统计分析

#### 手机App模块
- 页面数据采集（AccessibilityService）
- 页面变化监听
- 数据提取和格式化
- 数据实时上传

### 功能3：数据可视化展示

#### 前端模块
- **数据看板**：综合数据概览
- **图表展示**：
  - 折线图（数据趋势）
  - 柱状图（数据对比）
  - 饼图（数据分布）
  - 热力图（数据密度）
  - 散点图（数据关联）
- **统计分析**：
  - 数据汇总统计
  - 时间维度分析
  - 分类统计
  - 数据对比分析
- **实时数据流**：实时数据可视化更新

#### 后端模块
- 数据聚合服务（按时间、类型等聚合）
- 统计分析服务（计算统计数据）
- 数据导出服务（导出为Excel/CSV）
- 可视化数据API（提供图表所需数据格式）

#### 可视化数据类型
1. **页面访问统计**：页面访问次数、访问时长、访问路径
2. **元素交互统计**：点击次数、滑动次数、输入统计
3. **数据变化趋势**：数据采集量趋势、页面变化频率
4. **分类数据分布**：不同页面类型分布、不同操作类型分布
5. **时间维度分析**：按小时/天/周/月统计
6. **设备数据对比**：多设备数据对比（如有多台设备）

---

## 数据流转架构

### 操控功能数据流

#### 屏幕画面流
```
手机MediaProjection
  → 编码（JPEG/H.264）
  → WebSocket发送
  → 本地服务器接收
  → WebSocket转发
  → 前端接收
  → Canvas渲染显示
```

#### 控制指令流
```
前端用户操作
  → WebSocket发送
  → 本地服务器接收
  → WebSocket转发
  → 手机App接收
  → AccessibilityService执行
  → 目标App响应
```

### 抓包功能数据流

#### 数据采集流
```
目标App页面变化
  → AccessibilityService监听
  → 提取页面数据
  → 格式化JSON
  → WebSocket发送
  → 本地服务器接收
  → 存储到数据库
  → WebSocket推送前端
  → 前端实时展示
```

---

## 连接方式

### 方案A：USB ADB（推荐，稳定）
- 手机通过USB连接电脑
- 使用ADB连接
- 稳定，延迟低

### 方案B：网络ADB（无线）
- 手机和电脑同一WiFi
- 使用网络ADB
- 无线，但需保持网络稳定

### 方案C：混合方案（推荐）
- 首次USB连接，执行 `adb tcpip 5555`
- 后续使用网络ADB
- 兼顾稳定与灵活

---

## 数据库设计

### 数据存储方案

#### 方案A：SQLite（轻量，适合本地）
- 单文件数据库
- 无需单独服务
- 适合小规模数据

#### 方案B：PostgreSQL/MySQL（功能完整）
- 关系型数据库
- 功能完整
- 适合复杂查询

### 核心数据表

1. **devices**（设备表）
   - id, name, status, last_online, created_at

2. **captured_data**（采集数据表）
   - id, device_id, data_type, content, page_url, element_info, text_content, timestamp, created_at

3. **data_statistics**（数据统计表，用于可视化）
   - id, device_id, stat_type, stat_date, stat_value, metadata, created_at

4. **operation_logs**（操作日志表）
   - id, device_id, operation, details, timestamp, created_at

---

## 部署架构（本地）

### 前端部署
- 开发环境：`npm run dev`（Vite开发服务器）
- 访问：`http://localhost:5173`（Vite默认端口）

### 后端部署
- 运行：`node src/index.js` 或 `npm start`
- 端口：3000（HTTP）、3001（WebSocket）
- 访问：`http://localhost:3000`

### 手机App部署
- 编译：Android Studio编译APK
- 安装：USB安装或直接安装APK
- 配置：设置服务器地址为电脑IP（如 `192.168.1.100:3001`）

---

## 网络配置

### 本地网络设置
1. 电脑和手机在同一WiFi
2. 获取电脑IP（如 `192.168.1.100`）
3. 手机App配置服务器地址：`ws://192.168.1.100:3001`
4. 前端访问：`http://192.168.1.100:5173`（或localhost）

### 防火墙配置
- 开放后端端口（3000, 3001）
- 允许本地网络访问

---

## 开发优先级

### 第一阶段：基础通信
1. 搭建前端项目（React 19 + Vite + Ant Pro）
2. 搭建后端服务（Node.js + WebSocket）
3. 开发手机App基础通信
4. 实现设备连接

### 第二阶段：操控功能
1. 实现屏幕显示
2. 实现点击控制
3. 实现滑动控制
4. 完善控制功能

### 第三阶段：抓包功能
1. 实现页面数据采集
2. 实现数据实时传输
3. 实现数据展示
4. 完善数据功能

### 第三阶段补充：数据可视化
1. 实现数据统计分析
2. 实现数据可视化图表
3. 实现数据看板
4. 实现数据导出功能

### 第四阶段：优化完善
1. 性能优化
2. 稳定性提升
3. UI/UX优化
4. 错误处理

---

## 技术难点解决方案

### 难点1：无法Root，无法直接抓包
- **方案**：使用AccessibilityService采集页面数据
- **可获取**：页面元素、文本、结构
- **无法获取**：网络请求原始数据

### 难点2：屏幕传输性能
- **方案**：截图轮询（简单）或视频流（性能好）
- **优化**：降低分辨率、控制帧率、压缩传输

### 难点3：华为手机权限
- **方案**：引导用户配置必要权限
- **权限**：无障碍、屏幕录制、后台运行

---

## 权限配置

### 手机App所需权限
1. **无障碍服务权限**（必需）- 用于页面数据采集和控制
2. **屏幕录制权限**（必需）- 用于屏幕画面传输
3. **网络权限**（必需）- 用于与服务器通信
4. **前台服务权限**（必需）- 用于后台运行
5. **悬浮窗权限**（可选）- 用于显示控制面板
6. **电池优化白名单**（必需）- 保证24小时运行

---

## 开发环境要求

### 前端开发
- Node.js 20+
- npm 或 yarn
- 现代浏览器（Chrome、Edge等）

### 后端开发
- Node.js 20+
- ADB工具（android-platform-tools）
- 数据库（SQLite或PostgreSQL）

### 手机App开发
- Android Studio
- Android SDK 34
- Kotlin插件
- 华为手机（Android 7.0+）

---

## 开发调试功能

### 日志框功能需求
每个功能模块都需要提供日志查看功能，方便开发调试：

1. **日志框组件特性**：
   - 实时显示日志信息（时间戳 + 日志内容）
   - 支持一键复制所有日志
   - 支持清空日志
   - 自动滚动到最新日志
   - 支持不同日志级别（info、warn、error）的颜色区分
   - 日志自动换行显示

2. **日志框位置**：
   - 设备控制页面：显示连接日志、操作日志
   - 数据采集页面：显示数据采集日志、传输日志
   - 数据可视化页面：显示数据处理日志
   - 后端服务：控制台日志 + 日志文件
   - 手机App：日志通过WebSocket发送到前端显示

3. **日志格式**：
   ```
   [2024-12-XX HH:mm:ss] [级别] 日志内容
   ```

## 开发计划

### 当前阶段：第一阶段 - 基础通信
- [x] 编写开发文档
- [ ] 初始化前端项目（Umi 4 + Ant Design Pro 最新版）
- [ ] 初始化后端项目
- [ ] 初始化手机App项目
- [ ] 实现日志组件（支持复制、清空）
- [ ] 实现基础WebSocket通信
- [ ] 实现设备连接管理

---

## 更新日志

### 2024-12-XX
- 创建开发文档
- 确定技术架构
- 开始第一阶段开发

